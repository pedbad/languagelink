{% extends 'core/base.html' %}
{% load static %}
{% load booking_filters %}

{% block content %}
  <div id="student-booking-page">
    <div class="container mx-auto mt-10">
      <h1 class="page-title">Book a Meeting</h1>
      <hr class="page-divider">
      <h2 class="text-xl font-semibold text-gray-800 text-center flex-1 mb-4">{{ month_display }}</h2>

      <!-- Week Navigation -->
      <div class="flex items-center justify-center gap-4 mb-6">
        {% if disable_prev_week %}
          <span class="btn-secondary-sm opacity-50 cursor-not-allowed">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            Previous Week
          </span>
        {% else %}
          <a href="?date={{ prev_week }}" class="btn-secondary-sm">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            Previous Week
          </a>
        {% endif %}

        <div class="flex space-x-2">
          {% for day in week_dates %}
            {% if day in disabled_days %}
              <span class="px-4 py-2 rounded-lg text-sm font-medium shadow-lg cursor-not-allowed bg-gray-300 text-gray-500">
                {{ day|date:"l jS" }}
              </span>
            {% else %}
            <a href="?date={{ day|date:'Y-m-d' }}"
                class="px-4 py-2 rounded-lg text-sm font-medium shadow-lg transition duration-150 ease-in-out 
                  {% if day == selected_date %}
                    bg-deep-teal text-white font-bold
                  {% elif day == today %}
                    ring-2 ring-deep-teal text-deep-teal font-semibold
                  {% else %}
                    bg-gray-200 text-gray-700 hover:bg-gray-300
                  {% endif %}">
              {{ day|date:"l jS" }}
            </a>
        
            {% endif %}
          {% endfor %}
        </div>

        <a href="?date={{ next_week }}" class="btn-secondary-sm">
          Next Week
          <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </a>
      </div>

      <!-- Availability Table -->
      <div id="availability-table" class="overflow-x-auto mt-6 mb-28">
        <table class="w-full border-collapse border border-gray-300 text-sm sm:text-base mb-10">
          <thead>
            <tr>
              <th class="border border-gray-300 px-4 py-2 text-left"></th>
              <th colspan="6" class="border border-gray-300 px-4 py-1 text-center font-semibold bg-amber-100 text-gray-900 text-sm">
                Morning Availability
              </th>
              <th colspan="12" class="border border-gray-300 px-4 py-1 text-center font-semibold bg-sky-100 text-gray-900 text-sm">
                Afternoon Availability
              </th>
            </tr>
            <tr class="bg-gray-100">
              <th class="border border-gray-300 px-4 py-2">Advisor</th>
              {% for start_time, end_time in time_slots %}
                <th class="border border-gray-300 px-2 py-1 text-xs whitespace-nowrap">
                  {{ start_time|date:"g:i" }}
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3" />
                  </svg>
                  {{ end_time|date:"g:i" }}
                </th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% if teacher_profiles %}
              {% for teacher_email in teacher_profiles %}
                {% with slot_map=teacher_availability_by_email|get_item:teacher_email %}
                  {% with teacher=teacher_profiles|get_item:teacher_email %}
                    <tr class="text-center">
                      <!-- Teacher Info -->
                      <td class="border border-gray-300 px-2 py-2 text-center">
                        {% if teacher and teacher.profile_picture %}
                          <img src="{{ teacher.profile_picture.url }}" alt="Avatar" class="h-10 w-10 rounded-full mx-auto">
                        {% else %}
                          <img src="{% static 'core/img/default-profile.png' %}" alt="Default Avatar" class="h-10 w-10 rounded-full mx-auto">
                        {% endif %}
                        <p class="text-xs text-gray-700 mt-1">{{ teacher.user.first_name }} {{ teacher.user.last_name }}</p>
                        <p class="text-xs text-gray-700 mt-1">{{ teacher_email }}</p>
                      </td>

                      <!-- Time Slots for selected_date only -->
                      {% with date_str=selected_date|date:"Y-m-d" %}
                        {% for start_time, end_time in time_slots %}
                          {% with time_str=start_time|time:"H:i:s" %}
                            {% with key=date_str|add:","|add:time_str %}
                              <td class="border border-gray-300 text-center">
                                {% with availability=slot_map|get_item:key %}
                                  {% if availability %}
                                    {% if availability.booking %}
                                      {% if availability.booking.student.email == student_email %}
                                        <!-- Booked by this student: clickable modal -->
                                        <span class="booked-slot inline-flex items-center justify-center w-6 h-6 rounded-full bg-dark-orange text-white mx-auto cursor-pointer"
                                          title = "You have booked this slot"
                                          data-user-name = "{{ teacher.user.first_name }} {{ teacher.user.last_name }}"
                                          data-user-email = "{{ teacher_email }}"
                                          data-date = "{{ date_str }}"
                                          data-start = "{{ start_time|time:'H:i' }}"
                                          data-end = "{{ end_time|time:'H:i' }}"
                                          data-avatar = "{{ teacher.profile_picture.url|default:'/static/core/img/default-profile.png' }}"
                                          data-message = "{{ availability.booking.message|default:''|escape }}"
                                        >
                                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" />
                                          </svg>
                                        </span>
                                      {% else %}
                                        <!-- Booked by someone else: no modal, grey icon -->
                                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-400 text-white mx-auto cursor-not-allowed"
                                              title="This slot is already booked by another student">
                                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                                            <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clip-rule="evenodd" />
                                          </svg>
                                        </span>
                                      {% endif %}
                                    {% elif availability.is_available %}
                                      <!-- Available -->
                                      <span class="booking-slot inline-flex items-center justify-center w-6 h-6 rounded-full bg-green-500 text-white mx-auto cursor-pointer hover:bg-green-600 transition"
                                            data-teacher="{{ teacher_email }}"
                                            data-teacher-name="{{ teacher.user.first_name }} {{ teacher.user.last_name }}"
                                            data-avatar="{{ teacher.profile_picture.url|default_if_none:'' }}"
                                            data-date="{{ date_str }}"
                                            data-start="{{ start_time|time:'H:i:s' }}"
                                            data-end="{{ end_time|time:'H:i:s' }}"
                                            title="Click to book">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                          <path d="M5 12l5 5L20 7"/>
                                        </svg>
                                      </span>
                                    {% else %}
                                      <!-- Unavailable -->
                                      <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-pink-400 text-white mx-auto cursor-not-allowed" title="Unavailable">
                                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                          <path d="M6 6l12 12M18 6l-12 12"/>
                                        </svg>
                                      </span>
                                    {% endif %}
                                  {% else %}
                                    <!-- No Slot Defined -->
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-pink-400 text-white mx-auto cursor-not-allowed" title="Unavailable">
                                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M6 6l12 12M18 6l-12 12"/>
                                      </svg>
                                    </span>
                                  {% endif %}
                                {% endwith %}
                              </td>

                            {% endwith %}
                          {% endwith %}
                        {% endfor %}
                      {% endwith %}
                    </tr>
                  {% endwith %}
                {% endwith %}
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="{{ time_slots|length|add:1 }}" class="text-center text-gray-500 py-4">No available slots.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>


      <hr class="page-divider">

      <div class="mt-6 mb-20 text-center">
        {% if request.user.role == 'admin' %}
          <a href="{% url 'admin_dashboard' %}" class="btn-primary w-full">
            <!-- Chevron left icon-->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-2">
              <path stroke-linecap="round" stroke-linejoin="round" d="m18.75 4.5-7.5 7.5 7.5 7.5m-6-15L5.25 12l7.5 7.5" />
            </svg>
            Back to Dashboard
          </a>
        {% elif request.user.role == 'student' %}
          <a href="{% url 'student_profile' %}" class="btn-primary w-full">
            <!-- Chevron left icon-->
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 mr-2">
              <path stroke-linecap="round" stroke-linejoin="round" d="m18.75 4.5-7.5 7.5 7.5 7.5m-6-15L5.25 12l7.5 7.5" />
            </svg>
            Back to Profile
          </a>
        {% endif %}
      </div>

    </div><!-- eof .container-->
  </div><!-- eof #student-booking-page-->


  <!-- Booking Confirmation Modal -->
  <div id="bookingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">

      <!-- Close button -->
      <button id="close-booking-modal" type="button" 
              class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
        <span class="sr-only">Close</span>
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Modal Content -->
      <div class="text-center">
        <!-- Date Info -->
        <p id="modalSlotDetails" class="text-gray-600 text-center mb-4">
          Wednesday 28 May 2025 from 9:30 to 10:00
        </p>

        <!-- Avatar + Teacher Info -->
        <div class="flex items-center justify-center gap-4 mb-4">
          <img id="modalAvatar" src="{% static 'core/img/default-profile.png' %}" alt="Teacher Avatar" class="w-12 h-12 rounded-full">
          <div class="text-left">
            <p id="modalTeacherName" class="text-sm font-semibold text-gray-800">Advisor: Firstname Lastname</p>
            <p id="modalTeacherEmail" class="text-sm text-gray-600">Email: email@example.com</p>
          </div>
        </div>

        <!-- Optional Message Field -->
        <div class="mt-4 text-left">
          <label for="bookingMessage" class="block text-sm font-medium text-gray-700 mb-1">
            Optional message to your advisor:
          </label>
          <textarea id="bookingMessage" rows="4" maxlength="300"
                    class="w-full rounded-md border border-gray-300 shadow-sm focus:ring-deep-teal focus:border-deep-teal text-sm p-2"
                    placeholder="e.g. I'd like to discuss my essay draft or ask about module options..."></textarea>
        </div>

        <!-- Divider -->
        <hr class="my-4 border-t border-gray-200">

        <!-- Modal Actions -->
        <div class="mt-6 flex justify-end space-x-3">
          <button id="submit-booking-modal" type="button"
                  class="btn-primary">
            Book This Slot
          </button>
          <button id="cancel-booking-modal" type="button"
                  class="btn-danger">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>


  <!-- Booked Slot Info Modal -->
  <div id="bookedInfoModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">

      <!-- Close Button -->
      <button id="close-booked-info-modal" type="button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
        <span class="sr-only">Close</span>
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Modal Content -->
      <div class="text-center px-4">
        <h2 id="booked-slot-heading" class="text-lg font-semibold text-gray-800 mb-4">
          You have already booked this slot
        </h2>

        <p id="booked-slot-datetime" class="text-base text-gray-700 mb-4">
          You have a slot booked on …
        </p>

        <div class="flex items-center justify-center mt-4 space-x-4">
          <img id="booked-user-avatar" src="{% static 'core/img/default-profile.png' %}" alt="Profile Avatar" class="h-10 w-10 rounded-full object-cover">
          <div class="text-left">
            <p id="booked-user-name" class="text-sm font-semibold text-gray-800">Advisor: John Doe</p>
            <p id="booked-user-email" class="text-sm text-gray-600">Email: john@example.com</p>
          </div>
        </div>

      </div><!-- eof .text-center-->
      
      <!-- Divider -->
      <hr class="my-4 border-t border-gray-200">

      <!-- Optional Message from Student -->
      <div id="booked-student-message-container" class="mt-6 hidden">
        <div class="flex items-center gap-2 text-sm font-semibold text-gray-800 mb-1">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375m-13.5 3.01c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.184-4.183a1.14 1.14 0 0 1 .778-.332 48.294 48.294 0 0 0 5.83-.498c1.585-.233 2.708-1.626 2.708-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z" />
          </svg>
          <span>Your message to the Advisor:</span>
        </div>
        <p id="booked-student-message" class="text-sm text-gray-700 whitespace-pre-line"></p>
      </div>

    </div>
  </div>


  <!-- Toast Notification -->
  <div id="booking-toast"
      style="top: 25%; left: 50%; transform: translate(-50%, -50%);"
      class="fixed z-[9999] bg-green-600 text-white px-5 py-3 rounded-lg shadow-xl text-sm sm:text-base hidden transition-opacity duration-300 ease-in-out">
    Booking confirmed!
  </div>
  
{% endblock %}
