{% extends 'core/base.html' %}
{% load static %}
{% load booking_filters %}

{% block content %}
  <div class="container mx-auto mt-10">
    <h1 class="text-3xl font-light text-gray-900 text-center mb-6">Book a Meeting</h1>
    <hr class="my-4 border-1 border-gray-300 mb-6">
    <!-- Month & Year (Always Centered) -->
    <h2 class="text-xl font-semibold text-gray-800 text-center flex-1 mb-4">
      {{ month_display }}
    </h2>

    <!-- Week Navigation -->
    <div class="flex items-center justify-center gap-4 mb-6">
      <!-- Previous Week Button -->
      {% if disable_prev_week %}
        <span class="inline-flex items-center bg-gray-300 text-gray-500 px-4 py-2 text-sm font-medium leading-normal rounded-lg shadow-lg cursor-not-allowed">
          <!-- Heroicon Left Arrow -->
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
          </svg>
          Previous Week
        </span>
      {% else %}
        <a href="?date={{ prev_week }}" 
          class="inline-flex items-center bg-warm-brown text-white px-4 py-2 text-sm font-medium leading-normal rounded-lg shadow-lg transition duration-150 ease-in-out hover:bg-dark-orange focus:outline-none focus:ring-2 focus:ring-warm-brown focus:ring-opacity-50">
          <!-- Heroicon Left Arrow -->
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
          </svg>
          Previous Week
        </a>
      {% endif %}

      <!-- Weekday Buttons -->
      <div class="flex space-x-2">
        {% for day in week_dates %}
          {% if day in disabled_days %}
            <span class="px-4 py-2 rounded-lg text-sm font-medium shadow-lg cursor-not-allowed bg-gray-300 text-gray-500">
              {{ day|date:"l jS" }}
            </span>
          {% else %}
            <a href="?date={{ day|date:'Y-m-d' }}" 
              class="week-day-button px-4 py-2 rounded-lg text-sm font-medium shadow-lg transition duration-150 ease-in-out 
                {% if day == selected_date %} bg-deep-teal text-white font-bold {% else %} bg-gray-200 text-gray-700 hover:bg-gray-300 {% endif %}"
              data-date="{{ day|date:'Y-m-d' }}">
              {{ day|date:"l jS" }}
            </a>
          {% endif %}
        {% endfor %}
      </div>


      <!-- Next Week Button -->
      <a href="?date={{ next_week }}" 
        class="inline-flex items-center bg-warm-brown text-white px-4 py-2 text-sm font-medium leading-normal rounded-lg shadow-lg transition duration-150 ease-in-out hover:bg-dark-orange focus:outline-none focus:ring-2 focus:ring-warm-brown focus:ring-opacity-50">
        Next Week
        <!-- Heroicon Right Arrow -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 ml-2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
        </svg>
      </a>
    </div>

    <pre class="text-gray-800 text-center flex-1 mb-4">Selected Date: {{ selected_date }}</pre>
    <hr class="my-4 border-1 border-gray-300 mb-6">

    <!-- Available Slots Section -->
    <div id="available-slots" class="mt-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">Available Slots</h2>
      <div id="slots-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Slots will be dynamically inserted here -->
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const slotsContainer = document.getElementById("slots-container");
        const selectedDateElement = document.getElementById("selected-date-display");
    
        // Get the initially selected date (today or Monday of the selected week)
        let selectedDate = "{{ selected_date|date:'Y-m-d' }}"; 
    
        // Function to update highlighted button
        function updateSelectedButton(newDate) {
          document.querySelectorAll(".week-day-button").forEach(button => {
            if (button.getAttribute("data-date") === newDate) {
              button.classList.add("bg-deep-teal", "text-white", "font-bold");
              button.classList.remove("bg-gray-200", "text-gray-700", "hover:bg-gray-300");
            } else {
              button.classList.remove("bg-deep-teal", "text-white", "font-bold");
              button.classList.add("bg-gray-200", "text-gray-700", "hover:bg-gray-300");
            }
          });
        }
    
        // Function to fetch available slots
        function fetchAvailableSlots(date) {
          console.log(`Fetching slots for date: ${date}`); // Debugging
        
          fetch(`/booking/get-available-slots/?date=${date}`)
            .then(response => {
              console.log("Response status:", response.status); // Log status
              return response.json();
            })
            .then(data => {
              console.log("Slots Data:", data); // Log the fetched slots data
        
              if (!data.success) {
                console.error("Server Error:", data.error || "Unknown error");
                slotsContainer.innerHTML = `<p class='text-red-600'>Error: ${data.error}</p>`;
                return;
              }
        
              // Clear previous slots
              slotsContainer.innerHTML = "";
        
              if (Object.keys(data.slots).length > 0) {
                Object.entries(data.slots).forEach(([time, teachers]) => {
                  const slotDiv = document.createElement("div");
                  slotDiv.classList.add("p-4", "border", "rounded-lg", "shadow-md", "bg-white");
        
                  slotDiv.innerHTML = `
                    <p class="font-medium">${time}</p>
                    <p class="text-gray-700">Available with:</p>
                    <ul class="text-gray-600">
                      ${teachers.map(teacher => `<li>ðŸ‘¤ ${teacher}</li>`).join("")}
                    </ul>
                  `;
        
                  slotsContainer.appendChild(slotDiv);
                });
              } else {
                slotsContainer.innerHTML = "<p class='text-gray-600'>No available slots for this date.</p>";
              }
            })
            .catch(error => {
              console.error("Fetch Error:", error); // Log the actual error
              slotsContainer.innerHTML = "<p class='text-red-600'>Error loading slots.</p>";
            });
        }
        
    
        // Fetch slots for initially selected date
        fetchAvailableSlots(selectedDate);
        selectedDateElement.textContent = `Selected Date: ${new Date(selectedDate).toLocaleDateString('en-US', {
          weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        })}`;
        updateSelectedButton(selectedDate);
    
        // Add event listeners to **enabled weekday buttons only**
        document.querySelectorAll(".week-day-button").forEach(button => {
          button.addEventListener("click", function (event) {
            event.preventDefault();
    
            // Get the date from the `data-date` attribute
            let newDate = this.getAttribute("data-date");
    
            if (newDate) {
              selectedDate = newDate;
              fetchAvailableSlots(selectedDate);
            }
          });
        });
      });
    </script>
    
    
    


  </div>
{% endblock %}





